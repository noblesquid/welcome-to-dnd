<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>D&amp;D Invitation â€” Enhanced</title>

<!-- Fantasy font -->
<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English&display=swap" rel="stylesheet">

<style>
:root{
  --bg-dark:#0d0f12;
  --muted:#d0d4d8;
  --accent:#ffd8a0;
  --parchment:#f6e7b2;
  --parchment-ink:#3b2f1f;

  /* ðŸ”¥ STRONGER GLOW */
  --ember-core: rgba(255, 210, 150, 0.55);
  --ember-mid:  rgba(255, 190, 130, 0.45);
  --ember-soft: rgba(255, 180, 120, 0.45);
  --ember-falloff: rgba(180, 90, 40, 0.30);

  --ember-strong-core: rgba(255, 225, 170, 0.45);
  --ember-strong-mid:  rgba(255, 205, 150, 0.30);
  --ember-strong-soft: rgba(255, 195, 140, 0.45);
  --ember-strong-falloff: rgba(200, 110, 60, 0.30);
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{
  height:100%;width:100%;background:var(--bg-dark);
  font-family:"IM Fell English",serif;color:var(--muted);overflow:hidden;
}
button{font-family:inherit}

/* Overlay & Scene */
.overlay{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
 background: rgba(13, 15, 18, 0.2);
}
.overlay::after{
  content:"";position:absolute;inset:0;
  pointer-events:none;
}
.scene{
  width:min(900px,92vw);
  height:min(560px,78vh);
  position:relative;
  overflow:hidden;
  padding:24px;

  /* REMOVE visual framing */
  background: transparent;
  box-shadow: none;
  border-radius: 0;

  opacity: 0;
  pointer-events: none;
  transform: scale(0.95);
  transition: opacity .6s ease, transform .6s cubic-bezier(.2,.9,.2,1);
}

.scene.visible {
  opacity: 1;
  pointer-events: auto;
  transform: scale(1);
}

.visual-wrap{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}
.visual{
  width:100%;
  text-align:center;
  line-height:1.35;
  user-select:none;
  pointer-events:none;
  transition:opacity .42s ease, transform .42s ease;
  will-change:opacity,transform;
}
.fade-out{ opacity:0; transform:translateY(6px) scale(.995); }
.fade-in{ opacity:1; transform:translateY(0) scale(1); }

.plain-center{
  font-weight:600;
  font-size:1rem;
  color:#fff;
  text-align:center;
}

.text-reveal{
  opacity:0; 
  transform:translateY(8px);
  animation:reveal .46s ease forwards;
}
@keyframes reveal{ to{opacity:1; transform:translateY(0)} }

.parchment{
  position:absolute;
  left:50%;top:50%;
  transform:translate(-50%,-55%) scale(.97);
  padding:18px 22px;
  border-radius:12px;
  background:var(--parchment);
  border:1px solid rgba(0,0,0,0.06);
  min-width:320px;max-width:74%;
  opacity:0;
  pointer-events:auto;
  text-align:center;
  box-shadow:
    0 0 3px var(--ember-core),
    0 0 8px var(--ember-mid),
    0 0 14px var(--ember-soft),
    0 0 22px var(--ember-falloff);
  transition:
    opacity 0.45s ease, 
    transform 0.45s cubic-bezier(.2,.9,.2,1),
    box-shadow 0.25s ease;
}
.parchment.halo-strong{
  box-shadow:
    0 0 6px var(--ember-strong-core),
    0 0 14px var(--ember-strong-mid),
    0 0 26px var(--ember-strong-soft),
    0 0 38px var(--ember-strong-falloff);
}
.parchment--visible{
  opacity:1;
  transform: translate(-50%, -50%) scale(1.08);
  transition: opacity 0.45s ease, transform 0.45s cubic-bezier(.2,.9,.2,1);
}
.parchment--visible.fade-in-pop {
  animation: popfadein 0.45s forwards;
}
@keyframes popfadein {
  0%   { opacity: 0; transform: translate(-50%, -55%) scale(0.9); }
  100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
}
/* Reverse pop fade-out for parchment */
.parchment--reverse-pop {
  animation: reversePopFade 0.45s forwards;
}

@keyframes reversePopFade {
  0%   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  100% { opacity: 0; transform: translate(-50%, -55%) scale(0.9); }
}

.parchment::before{
  content:"";
  position:absolute;
  inset:-6px;
  pointer-events:none;
  border-radius:inherit;
  background:
    radial-gradient(circle at 12% 10%, rgba(255,140,70,0.18) 0%, transparent 40%),
    radial-gradient(circle at 88% 12%, rgba(255,140,70,0.14) 0%, transparent 40%),
    radial-gradient(circle at 12% 92%, rgba(255,140,70,0.16) 0%, transparent 40%),
    radial-gradient(circle at 88% 88%, rgba(255,140,70,0.12) 0%, transparent 40%);
  opacity:0.24;
  animation:embers 6s ease-in-out infinite;
  mix-blend-mode:screen;
}

@keyframes embers {
  0%   { opacity:0.18; transform:scale(1); }
  25%  { opacity:0.28; transform:scale(1.01); }
  50%  { opacity:0.34; transform:scale(1.02); }
  75%  { opacity:0.26; transform:scale(1.01); }
  100% { opacity:0.18; transform:scale(1); }
}

.parchment-text{ color:var(--parchment-ink); font-weight:500; font-size:.98rem; line-height:1.45; margin-bottom:8px; }
.parchment-sub{ color:#6a533f; font-style:italic; font-size:.85rem; line-height:1.25; }

.choices{
  position:absolute;
  left:50%;top:55%;
  transform:translate(-50%,-50%);
  display:flex;gap:18px;
  z-index:40;
  pointer-events:auto;
}
.choice{
  padding:10px 18px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);
  font-weight:600;cursor:pointer;background:var(--parchment);color:var(--parchment-ink);font-size:.9rem;
  opacity:0; transform:translateY(10px);
  transition:opacity .36s ease, transform .36s ease, filter .12s ease, box-shadow .28s ease;
  box-shadow:
    0 0 4px var(--ember-core),
    0 0 10px var(--ember-mid),
    0 0 18px var(--ember-soft),
    0 0 30px var(--ember-falloff);
}
.choice:hover{
  filter:brightness(1.04);
  box-shadow:
    0 0 6px var(--ember-strong-core),
    0 0 14px var(--ember-strong-mid),
    0 0 26px var(--ember-strong-soft),
    0 0 38px var(--ember-strong-falloff);
}

.continue{
  position:absolute;
  color:var(--muted);
  font-size:.85rem;
  pointer-events:auto;
  user-select:none;
  opacity: 0;
  transition: opacity 0.35s ease;
}

/* RPG-style pulse using opacity only */
.continue--visible{
  opacity: 1;
  animation: rpgPulse 1.6s ease-in-out infinite;
}

@keyframes rpgPulse {
  0%   { opacity: 0.35; }
  50%  { opacity: 0.85; }
  100% { opacity: 0.35; }
}

.typewriter{
  display:inline-block; white-space:pre-wrap; overflow:hidden;
  border-right:2px solid rgba(60,40,20,0.6);
  animation:caret .9s steps(1) infinite;
}
@keyframes caret{ 50%{ border-right-color:transparent; } }

.hidden{ display:none!important; }

@media (max-width:520px){
  .scene{ padding:12px; border-radius:8px; }
  .parchment{ min-width:260px; max-width:88%; padding:14px }
  .choice{ padding:9px 12px; font-size:.85rem }
}

/* Start button on full screen */
#start-screen {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-dark);
  z-index: 100;
  opacity: 1;
  transition: opacity 0.6s ease;
}
#start-screen.fade-out {
  opacity: 0;
  pointer-events: none;
}
#start-screen button {
  background: var(--parchment);
  color: var(--parchment-ink);
  border: none;
  border-radius: 12px;
  padding: 18px 36px;
  font-size: 1.5rem;
  font-weight: 700;
  cursor: pointer;
  box-shadow:
    0 0 10px var(--ember-core),
    0 0 20px var(--ember-mid);
  transition: filter 0.3s ease;
}
#start-screen button:hover {
  filter: brightness(1.1);
}
.rune-circle {
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.8s ease;
  z-index: 1; /* behind parchment & text */
}

.rune-circle .rune {
  position: absolute;
  font-size: 2rem;
  color: var(--accent);
  text-shadow:
    0 0 4px var(--ember-core),
    0 0 10px var(--ember-mid),
    0 0 16px var(--ember-soft);
  opacity: 0.85;
  animation: pulse 2s ease-in-out infinite alternate;
}

/* Glow pulse animation */
@keyframes pulse {
  0% { text-shadow: 0 0 4px var(--ember-core), 0 0 10px var(--ember-mid), 0 0 16px var(--ember-soft); transform: scale(1); }
  50% { text-shadow: 0 0 12px var(--ember-core), 0 0 24px var(--ember-mid), 0 0 32px var(--ember-soft); transform: scale(1.05); }
  100% { text-shadow: 0 0 4px var(--ember-core), 0 0 10px var(--ember-mid), 0 0 16px var(--ember-soft); transform: scale(1); }
}

/* Fade in/out helpers */
.rune-circle.visible { opacity: 1; }
.rune-circle.fade-out { opacity: 0; transition: opacity 0.8s ease; }


@keyframes flashRed {
  0% {
    color: var(--accent);
    text-shadow:
      0 0 4px var(--ember-core),
      0 0 10px var(--ember-mid),
      0 0 16px var(--ember-soft);
    opacity: 0.85;
  }

  40% {
    color: rgb(255, 120, 120); /* ember-red, not pure red */
    text-shadow:
      0 0 8px rgba(255, 80, 80, 0.55),
      0 0 18px rgba(255, 60, 60, 0.45),
      0 0 28px rgba(180, 40, 40, 0.35);
    opacity: 1;
  }

  60% {
    color: rgb(255, 140, 140);
    text-shadow:
      0 0 6px rgba(255, 90, 90, 0.45),
      0 0 14px rgba(255, 70, 70, 0.35),
      0 0 22px rgba(160, 40, 40, 0.25);
  }

  100% {
    color: var(--accent);
    text-shadow:
      0 0 4px var(--ember-core),
      0 0 10px var(--ember-mid),
      0 0 16px var(--ember-soft);
    opacity: 0.85;
  }
}

.rune-circle.flash-red .rune {
  animation: flashRed 0.2s ease-in-out 2; /* flashes 3 times */
}
#dust {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;             /* behind all content */
  pointer-events: none;   /* clicks go through canvas */
}

</style>
</head>
<body>

<!-- Start screen with Start your quest button -->
<div id="start-screen" role="dialog" aria-modal="true" aria-label="Start invitation and music">
  <button id="start-btn" aria-label="Start the invitation and play music">Start your quest</button>
</div>

<!-- Audio -->
<audio id="bgm" src="sound/bgm.wav" loop preload="auto" muted></audio>
<audio id="knock-sfx" src="sound/knock-sfx.mp3" preload="auto"></audio>
<audio id="paper-sfx" src="sound/page.mp3" preload="auto"></audio>
<audio id="ping-sfx" src="sound/ping-sfx.mp3" preload="auto"></audio>
<audio id="thunder-sfx" src="sound/thunder-sfx.mp3" preload="auto"></audio>
<audio id="steps-sfx" src="sound/steps-sfx.mp3" preload="auto"></audio>
<audio id="eerie-sfx" src="sound/eerie-sfx.mp3" preload="auto"></audio>

<canvas id="dust"></canvas>

<div id="inv-overlay" class="overlay" style="display:none;">
  <div id="scene" class="scene" role="dialog" aria-modal="true" aria-label="Dungeons &amp; Dragons Invitation">
    <div class="visual-wrap">
      <div id="visual" class="visual fade-in" aria-live="polite"></div>
    </div>
    <div id="rune-circle" class="rune-circle" aria-hidden="true"></div>

    <div id="parchment" class="parchment" aria-hidden="true" role="document">
      <div id="parchment-text" class="parchment-text"></div>
      <div id="parchment-sub" class="parchment-sub"></div>
    </div>

    <div id="choices" class="choices hidden" role="group" aria-label="Invitation choices">
      <button id="btn-yes" class="choice" aria-pressed="false">Accept</button>
      <button id="btn-no"  class="choice" aria-pressed="false">Refuse</button>
    </div>

    <div id="continue" class="continue hidden" aria-hidden="true" title="Click to advance">â–¼ Click to continue â–¼</div>
  </div>
</div>

<script>
(() => {
  const startScreen = document.getElementById('start-screen');
  const startBtn = document.getElementById('start-btn');
  const overlay = document.getElementById('inv-overlay');
  const sceneEl = document.getElementById('scene');
  const visual = document.getElementById('visual');
  const parchment = document.getElementById('parchment');
  const pText = document.getElementById('parchment-text');
  const pSub = document.getElementById('parchment-sub');
  const continueEl = document.getElementById('continue');
  const choices = document.getElementById('choices');
  const btnYes = document.getElementById('btn-yes');
  const btnNo  = document.getElementById('btn-no');

  const bgm = document.getElementById("bgm");
  const knockSfx = document.getElementById("knock-sfx");
  const paperSfx = document.getElementById("paper-sfx");
  const pingSfx = document.getElementById("ping-sfx");
  const thunderSfx = document.getElementById("thunder-sfx");
  const stepsSfx = document.getElementById("steps-sfx");
  const eerieSfx = document.getElementById("eerie-sfx");

  bgm.volume = 0.60;
  knockSfx.volume = 0.40;
  paperSfx.volume = 0.15;
  pingSfx.volume = 0.15;
  thunderSfx.volume = 0.60;
  stepsSfx.volume = 0.2;
  eerieSfx.volume = 0.15;
  // Disable looping on footsteps sound
  stepsSfx.loop = false;

  let scene = 0;
  let typingTimer = null;
  let footstepsFadeInterval = null;
  let lockAdvance = false; // â† ADD THIS


  function clearTyping(showFull = true) {
    if (typingTimer) {
      clearTimeout(typingTimer.timeoutId);
      if (showFull && typingTimer.finishText && typingTimer.el) {
        typingTimer.el.textContent = typingTimer.finishText;
      }
      typingTimer = null;
    }
    document.querySelectorAll('.typewriter').forEach(e => e.classList.remove('typewriter'));
  }

  function startTypewriter(text, el, baseSpeed = 35, onComplete = null) {
    clearTyping(false);
    el.textContent = '';
    el.classList.add('typewriter');
    let i = 0;
    const total = text.length;

    function step() {
      el.textContent += text[i] || '';
      i++;
      if (i >= total) {
        el.classList.remove('typewriter');
        typingTimer = null;
        if (typeof onComplete === 'function') onComplete();
        return;
      }
      const lastChar = text[i-1];
      const prevThree = text.slice(Math.max(0, i-3), i);
      let delay = baseSpeed;
      if (prevThree === '...') delay = baseSpeed * 5;
      else if (lastChar === '.' || lastChar === ',') delay = baseSpeed * 2;

      typingTimer = {
        el,
        finishText: text,
        timeoutId: setTimeout(step, delay)
      };
    }

    typingTimer = {
      el,
      finishText: text,
      timeoutId: setTimeout(step, baseSpeed)
    };
  }

  // Fade out footsteps audio gradually over 6 seconds
  function fadeOutFootsteps() {
    clearInterval(footstepsFadeInterval);
    const fadeDuration = 6000; // 6 seconds total
    const fadeStepTime = 100;  // update volume every 100ms
    const steps = fadeDuration / fadeStepTime;
    const initialVolume = stepsSfx.volume || 0.2; // fallback to 0.2 if volume 0
    const volumeStep = initialVolume / steps;
    let currentStep = 0;

    footstepsFadeInterval = setInterval(() => {
      currentStep++;
      let newVolume = initialVolume - volumeStep * currentStep;
      if (newVolume > 0) {
        stepsSfx.volume = newVolume;
      } else {
        stepsSfx.volume = 0;
        stepsSfx.pause();
        stepsSfx.currentTime = 0;
        clearInterval(footstepsFadeInterval);
      }
    }, fadeStepTime);
  }

  // Show continue without interfering with footsteps sound
  function showContinueBelow(targetEl = null) {
    if (!continueEl.classList.contains('hidden')) return; // avoid retrigger

    continueEl.classList.remove('hidden', 'fade-out');
    continueEl.setAttribute('aria-hidden','false');
    continueEl.classList.add('continue--visible');
    requestAnimationFrame(() => {
      const sRect = sceneEl.getBoundingClientRect();
      let left = sRect.width / 2;
      let top = sRect.height * 0.90;
      if (targetEl) {
        const r = targetEl.getBoundingClientRect();
        left = (r.left + r.right) / 2 - sRect.left;
        top = (r.bottom - sRect.top) + 32;
      }
      continueEl.style.left = left + 'px';
      continueEl.style.top = top + 'px';
      continueEl.style.transform = 'translate(-50%,0)';
    });
  }
 function hideContinue() {
  if (continueEl.classList.contains('hidden') || continueEl.classList.contains('fade-out')) return;

  continueEl.classList.remove('continue--visible');
  continueEl.setAttribute('aria-hidden','true');

  setTimeout(() => {
    continueEl.classList.add('hidden');
    continueEl.classList.remove('fade-out');
  }, 350);
}

  function centerParchment() {
    parchment.style.left = '50%';
    parchment.style.top = '50%';
  }

  // Show parchment with optional typewriter text
  function showParchment(text, sub = '', useTypewriter = false, speed = 36, popFadeIn = false) {
    clearTyping();
    pText.textContent = '';
    pSub.textContent = '';
    parchment.classList.remove('hidden');
    parchment.setAttribute('aria-hidden','false');

    requestAnimationFrame(() => {
      if(popFadeIn) {
        parchment.classList.add('parchment--visible', 'fade-in-pop');
      } else {
        parchment.classList.add('parchment--visible');
      }
      centerParchment();
      if (useTypewriter) {
        startTypewriter(text, pText, speed, () => {
          pSub.textContent = sub;
          showContinueBelow(parchment);
        });
      } else {
        pText.textContent = text;
        pSub.textContent = sub;
        showContinueBelow(parchment);
      }
    });
  }
  function fadeOutParchment(callback) {
  parchment.classList.add('parchment--reverse-pop');
  parchment.classList.remove('parchment--visible', 'fade-in-pop');
  parchment.setAttribute('aria-hidden', 'true');
  setTimeout(() => {
    parchment.classList.remove('parchment--reverse-pop');
    parchment.classList.add('hidden');
    if (callback) callback();
  }, 450); // Match the existing reverse pop fade duration
}

function hideParchment(reversePop = false) {
  clearTyping();
  if (reversePop) {
    parchment.classList.remove('parchment--visible', 'fade-in-pop');
    parchment.classList.add('parchment--reverse-pop');
    parchment.setAttribute('aria-hidden','true');
    setTimeout(() => {
      parchment.classList.remove('parchment--reverse-pop');
      parchment.classList.add('hidden');
    }, 450);
  } else {
    parchment.classList.remove('parchment--visible', 'fade-in-pop');
    parchment.setAttribute('aria-hidden','true');
    setTimeout(() => parchment.classList.add('hidden'), 420);
  }
}


  function revealChoices() {
    choices.classList.remove('hidden');
    choices.setAttribute('aria-hidden','false');
    const btns = Array.from(choices.children);
    btns.forEach(b => { b.style.opacity = 0; b.style.transform = 'translateY(10px)'; });
    requestAnimationFrame(() => {
      btns.forEach((btn, i) => {
        setTimeout(() => {
          btn.style.opacity = 1;
          btn.style.transform = 'translateY(0)';
        }, i * 80);
      });
    });
    hideContinue();
  }

  function hideChoices() {
    const btns = Array.from(choices.children);
    btns.forEach((btn, i) => {
      setTimeout(() => {
        btn.style.opacity = 0;
        btn.style.transform = 'translateY(10px)';
      }, i * 30);
    });
    setTimeout(() => choices.classList.add('hidden'), 220);
  }

  function crossfade(changeFn) {
    const duration = 420;
    visual.classList.add('fade-out');
    visual.classList.remove('fade-in');
    setTimeout(() => {
      changeFn();
      visual.classList.remove('fade-out');
      visual.classList.add('fade-in');
    }, duration);
  }

  // Scene 0: Knock on the door
  function scene0() {
    knockSfx.currentTime = 0;
    knockSfx.play().catch(()=>{});
    crossfade(() => {
      visual.innerHTML = `<div class="plain-center text-reveal" id="knock-text">Someone knocks on your door...</div>`;
      hideParchment();
      hideChoices();
      const tEl = document.getElementById('knock-text');
      setTimeout(() => showContinueBelow(tEl), 420);
    });
  }

  // Scene 1: They hand you a letter...
  function scene1() {
    crossfade(() => {
      visual.innerHTML = `<div class="plain-center"><span id="letter-plain"></span></div>`;
      hideParchment();
      hideChoices();
      const el = document.getElementById('letter-plain');
      startTypewriter("They hand you a letter...", el, 40, () => {
        sceneEl.classList.add('visible');
        showContinueBelow(el);
      });
    });
  }

  // Scene 2: Show parchment with message - with pop fade in effect
  function scene2() {
    crossfade(() => {
      visual.innerHTML = '';
      hideChoices();

      paperSfx.currentTime = 0;
      paperSfx.play().catch(() => {});

      showParchment(
        "Greetings, brave and probably foolish adventurer! You have been chosen to embark on a perilous quest that will test your courage, wit, and sense of humour. The realm doesn't need heroes... but it does need some help.",
        "â€“ from the dungeon master",
        false,
        36,
        true // popFadeIn enabled here
      );
    });
  }

  // Scene 3: Show choices Yes/No
  function scene3() {
    crossfade(() => {
      hideParchment();
      visual.innerHTML = '';
      revealChoices();
      const old = document.querySelector('.calltext');
      if (old) old.remove();
      const t = document.createElement('div');
      t.className = 'calltext';
      t.textContent = 'Will you heed the call?';
      t.style.position = 'absolute';
      t.style.left = '50%';
      t.style.top = '65%';
      t.style.transform = 'translate(-50%,-50%)';
      t.style.color = 'var(--muted)';
      t.style.fontWeight = 500;
      t.style.fontSize = '.9rem';
      t.style.pointerEvents = 'none';
      sceneEl.appendChild(t);
      hideContinue();
    });
  }
  // Scene 4: Fate sealed text (advance on ANY click)
  // Scene 4: Fate sealed text (advance on ANY click)
  function sceneFateSealed(nextCallback) {
     lockAdvance = true; // ðŸ”’ lock global advancing during fate scene

    crossfade(() => {
      hideParchment();
      visual.innerHTML = `<div class="plain-center" id="fate-text"></div>`;
      const el = document.getElementById('fate-text');

      // Start typewriter
      startTypewriter("Your fate has been sealed.", el, 50, () => {
        showContinueBelow(el);
        // Jiggle Refuse button after fate text appears
        btnNo.classList.add('jiggle');
      });
    });

const advanceOnce = () => {
  if (scene !== 4) return;

  lockAdvance = false;
  hideContinue();
  btnNo.classList.remove('jiggle', 'jiggle-strong');

  // ðŸ”¥ HARD CLEAR THE FATE TEXT BEFORE LEAVING SCENE 4
  visual.innerHTML = '';

  overlay.removeEventListener('click', advanceOnce);

  if (typeof nextCallback === 'function') {
    nextCallback();
  }
};
    overlay.addEventListener('click', advanceOnce);
  }


  // Scene 6: Ending footsteps fade + message
  function scene6() {
    crossfade(() => {
      hideParchment();
      visual.innerHTML = `<div class="plain-center"><span id="leave-text"></span></div>`;
      const el = document.getElementById('leave-text');

      try {
        stepsSfx.currentTime = 0;
        stepsSfx.volume = 0.5;
        stepsSfx.play();
      } catch (e) {}

      // Start footsteps fadeout immediately as typing starts
      fadeOutFootsteps();
      startTypewriter("The strange person leaves...", el, 48, () => {
        showContinueBelow(el);
      });
      hideChoices();
    });
  }
  // Scene 7: Final dice epilogue
function scene7_diceEpilogue() {
  crossfade(() => {
    hideParchment();
    hideChoices();
    hideContinue();

    visual.innerHTML = `<div class="plain-center" id="dice-text"></div>`;
    const el = document.getElementById('dice-text');

    // VERY slow typewriter
    startTypewriter(
      "Somewhere far away... a die falls onto a waiting table.",
      el,
      80, // slow typing speed
      () => {
        // Wait 3 seconds after fully written, then fade out
        setTimeout(() => {
          visual.classList.add('fade-out');

          setTimeout(() => {
            endSequence();
          }, 600); // allow fade-out to finish
        }, 3000);
      }
    );
  });
}

  // End all sequences & fade overlay
  function endSequence() {
    fadeOutFootsteps();
    overlay.style.transition = 'opacity .44s ease';
    overlay.style.opacity = '0';
    setTimeout(() => { if (overlay.parentNode) overlay.remove(); }, 520);
  }

  // Fade out parchment helper for scene 5 transition
  function fadeOutParchment(callback) {
    parchment.classList.add('parchment--reverse-pop');
    parchment.classList.remove('parchment--visible', 'fade-in-pop');
    parchment.setAttribute('aria-hidden', 'true');
    setTimeout(() => {
      parchment.classList.remove('parchment--reverse-pop');
      parchment.classList.add('hidden');
      if (callback) callback();
    }, 450); // match the fade duration
  }

  // Handle advancing scenes or skipping typing
  function handleAdvance() {
    if (lockAdvance) return; 
    if (typingTimer) { clearTyping(true); return; }
  switch(scene) {

    case 0: scene = 1; hideContinue(); scene1(); break;
    case 1: scene = 2; hideContinue(); scene2(); break;
    case 2: 
  scene = 3; 
  hideParchment(true); // reverse pop effect
  hideContinue(); 
  scene3(); 
  break;

    case 3: /* wait for choice */ break;
    case 4: /* fate-sealed, waiting for continue click, ignore overlay */ break;
    case 5: 
      hideContinue();
      // Fade out parchment before going to scene 6
      fadeOutParchment(() => {
        scene = 6;
        scene6();
      });
      break;
    case 6:
     scene = 7;
     hideContinue();
     scene7_diceEpilogue();
     break;

    case 7:
    // Do nothing â€” auto-fades and ends
    break;
  }
}
// Rune circle helper
function createRuneCircle() {
  const runeContainer = document.getElementById('rune-circle');
  runeContainer.innerHTML = ''; // clear previous runes

  const runes = ['áš ','áš¢','áš¦','áš©','áš±','áš³','áš·','áš¹','ášº','áš¾','á›','á›ƒ']; // example runes
  const radius = Math.min(sceneEl.clientWidth, sceneEl.clientHeight) / 2 - 40;

  runes.forEach((rune, i) => {
    const angle = (i / runes.length) * 2 * Math.PI;
    const x = Math.cos(angle) * radius;
    const y = Math.sin(angle) * radius;

    const span = document.createElement('span');
    span.className = 'rune';
    span.textContent = rune;
    span.style.left = `calc(50% + ${x}px)`;
    span.style.top = `calc(50% + ${y}px)`;

    runeContainer.appendChild(span);
  });

  // Fade in
  requestAnimationFrame(() => {
    runeContainer.classList.add('visible');
  });
}

// Fade out rune circle
function fadeOutRuneCircle() {
  const runeContainer = document.getElementById('rune-circle');
  runeContainer.classList.remove('visible');
  runeContainer.classList.add('fade-out');
  setTimeout(() => {
    runeContainer.classList.remove('fade-out');
    runeContainer.innerHTML = '';
  }, 800); // match CSS transition
}


  // Choices listeners
btnYes.addEventListener('click', (e) => {
  e.stopPropagation();
  pingSfx.currentTime = 0;
  pingSfx.play().catch(() => {});
  hideChoices();
  document.querySelector('.calltext')?.remove();

  createRuneCircle(); // <--- show rune circle here

  scene = 4; // fate-sealed
  sceneFateSealed(() => {
    fadeOutRuneCircle(); // <--- fade out after text types
    scene = 5; // Yes response
    showParchment(
      "It's the beginning of a new time â€” full of mist and terror. And you... are about to become a part of it all. Good luck!",
      "",
      true,
      40
    );
  });
});

btnNo.addEventListener('click', (e) => {
  e.stopPropagation();
  eerieSfx.currentTime = 0;
  eerieSfx.play().catch(() => {});
  thunderSfx.currentTime = 0;
  thunderSfx.play().catch(() => {});
  hideChoices();
  document.querySelector('.calltext')?.remove();

  createRuneCircle(); // show rune circle

  // Flash red effect
  const runeCircle = document.getElementById('rune-circle');
  runeCircle.classList.add('flash-red');
  setTimeout(() => runeCircle.classList.remove('flash-red'), 1000); // remove after animation

  scene = 4; // fate-sealed
  sceneFateSealed(() => {
    fadeOutRuneCircle(); // fade out after text types
    scene = 5; // No response
    showParchment(
      "What a shame. Just when the world found its last hope... well... goodbye.",
      "",
      true,
      48
    );
  });
});


  // Overlay click advances scene except buttons
  overlay.addEventListener('click', (e) => {
    if (e.target === btnYes || e.target === btnNo) return;
    handleAdvance();
  });

  // Keyboard controls
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      const active = document.activeElement;
      if (!choices.classList.contains('hidden') && (active === btnYes || active === btnNo)) {
        active.click();
        e.preventDefault();
        return;
      }
      handleAdvance();
    } else if (e.key === 'Escape') {
      endSequence();
    }
  });

  continueEl.addEventListener('mouseenter', () => parchment.classList.add('halo-strong'));
  continueEl.addEventListener('mouseleave', () => parchment.classList.remove('halo-strong'));

  startBtn.addEventListener('click', () => {
  startBtn.disabled = true;
  startScreen.classList.add('fade-out');

  setTimeout(() => {
    startScreen.style.display = 'none';
    overlay.style.display = 'flex';
    sceneEl.classList.add('visible');
    bgm.muted = true;
    bgm.play().then(() => {
      setTimeout(() => {
        bgm.muted = false;
      }, 500);
    }).catch(() => {});

    scene = 0; // Make sure the first scene is Scene 0
    visual.classList.add('fade-in');
    scene0();
  }, 600);
});
// --------- Dust Particle Code ---------
const dustCanvas = document.getElementById("dust");
const dustCtx = dustCanvas.getContext("2d");

function resizeDust() {
  dustCanvas.width = window.innerWidth;
  dustCanvas.height = window.innerHeight;
}
resizeDust();
window.addEventListener("resize", resizeDust);

const dustParticles = [];
const dustCount = 65;

let gust = { x: 0, y: 0, strength: 0, targetStrength: 0, angle: 0, timer: 0 };

function updateGust() {
  gust.timer--;
  if (gust.timer <= 0) {
    gust.angle = Math.random() * Math.PI * 2;
    gust.targetStrength = Math.random() * 0.007 + 0.003;
    gust.timer = Math.random() * 150 + 120;
  }
  gust.strength += (gust.targetStrength - gust.strength) * 0.015;
  if (gust.timer < 50) gust.targetStrength = 0;
  gust.x = Math.cos(gust.angle) * gust.strength;
  gust.y = Math.sin(gust.angle) * gust.strength;
}

class DustParticle {
  constructor(depth) {
    this.depth = depth;
    this.x = Math.random() * dustCanvas.width;
    this.y = Math.random() * dustCanvas.height;
    this.size = (Math.random() * 0.6 + 0.2) * depth;
    this.vx = (Math.random() - 0.5) * 0.025 * depth;
    this.vy = (Math.random() - 0.5) * 0.025 * depth;
    this.baseAlpha = Math.random() * 0.18 + 0.1;
    this.alpha = this.baseAlpha;
  }

  update() {
    this.vx += (Math.random() - 0.5) * 0.0015 * this.depth;
    this.vy += (Math.random() - 0.5) * 0.0015 * this.depth;
    this.vx += gust.x * this.depth;
    this.vy += gust.y * this.depth;
    this.vx *= 0.992;
    this.vy *= 0.992;
    this.x += this.vx;
    this.y += this.vy;

    if (this.x < -10) this.x = dustCanvas.width + 10;
    if (this.x > dustCanvas.width + 10) this.x = -10;
    if (this.y < -10) this.y = dustCanvas.height + 10;
    if (this.y > dustCanvas.height + 10) this.y = -10;

    this.alpha += (Math.random() - 0.5) * 0.0008;
    this.alpha = Math.max(0.05, Math.min(this.alpha, this.baseAlpha + 0.03));
  }

  draw() {
    dustCtx.save();
    dustCtx.globalAlpha = this.alpha;
    dustCtx.filter = `blur(${(1 - this.depth) * 1.5}px)`;
    dustCtx.beginPath();
    dustCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    dustCtx.fillStyle = "white";
    dustCtx.fill();
    dustCtx.restore();
  }
}

// Create dust particles
for (let i = 0; i < dustCount; i++) {
  const depth = Math.random() * 0.7 + 0.3;
  dustParticles.push(new DustParticle(depth));
}

// Animate dust
function animateDust() {
  dustCtx.clearRect(0, 0, dustCanvas.width, dustCanvas.height);
  updateGust();
  dustParticles.forEach(p => { p.update(); p.draw(); });
  requestAnimationFrame(animateDust);
}
animateDust();


})();
</script>

</body>
</html>
